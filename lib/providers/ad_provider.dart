import 'dart:io';
import 'package:flutter/foundation.dart';
import 'package:google_mobile_ads/google_mobile_ads.dart';
import 'package:shared_preferences/shared_preferences.dart';
import '../constants/admob_config.dart';

class AdProvider extends ChangeNotifier {
  // IDs des publicit√©s (utilise la configuration centralis√©e)
  static String get _bannerAdUnitId => AdMobConfig.bannerAdUnitId;
  static String get _interstitialAdUnitId => AdMobConfig.interstitialAdUnitId;
  static String get _rewardedAdUnitId => AdMobConfig.rewardedAdUnitId;

  // Variables d'√©tat
  bool _isInitialized = false;
  bool _adsEnabled = true;
  int _adFreePurchased = 0; // 0 = pas achet√©, 1 = achet√©
  int _interstitialCounter = 0;
  int _lastAdShownLevel = 0;

  // Constructeur avec initialisation automatique
  AdProvider() {
    initialize();
  }

  // Getters
  bool get isInitialized => _isInitialized;
  bool get adsEnabled => _adsEnabled; // ‚úÖ R√©activer les publicit√©s
  int get interstitialCounter => _interstitialCounter;
  int get lastAdShownLevel => _lastAdShownLevel;

  // Initialisation
  Future<void> initialize() async {
    if (_isInitialized) return;

    try {
      // ‚úÖ R√©activer AdMob avec la configuration correcte
      _adsEnabled = true;
      await _loadUserPreferences();
      _isInitialized = true;

      if (kDebugMode) {
        print('üöÄ AdProvider initialized successfully (ads enabled)');
        print('üì± Platform: ${Platform.isAndroid ? 'Android' : 'iOS'}');
        print('üéØ Banner Ad Unit ID: $_bannerAdUnitId');
        print('üéØ Interstitial Ad Unit ID: $_interstitialAdUnitId');
        print('üéØ Rewarded Ad Unit ID: $_rewardedAdUnitId');
      }
    } catch (e) {
      if (kDebugMode) {
        print('Error initializing AdProvider: $e');
      }
    }
  }

  // Charger les pr√©f√©rences utilisateur
  Future<void> _loadUserPreferences() async {
    final prefs = await SharedPreferences.getInstance();
    _adsEnabled = prefs.getBool('ads_enabled') ?? true;
    _adFreePurchased = prefs.getInt('ad_free_purchased') ?? 0;
    _interstitialCounter = prefs.getInt('interstitial_counter') ?? 0;
    _lastAdShownLevel = prefs.getInt('last_ad_shown_level') ?? 0;
  }

  // Sauvegarder les pr√©f√©rences utilisateur
  Future<void> _saveUserPreferences() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool('ads_enabled', _adsEnabled);
    await prefs.setInt('ad_free_purchased', _adFreePurchased);
    await prefs.setInt('interstitial_counter', _interstitialCounter);
    await prefs.setInt('last_ad_shown_level', _lastAdShownLevel);
  }

  // Cr√©er une banni√®re publicitaire
  BannerAd createBannerAd() {
    return BannerAd(
      adUnitId: _bannerAdUnitId,
      size: AdSize.banner,
      request: const AdRequest(),
      listener: BannerAdListener(
        onAdLoaded: (ad) {
          if (kDebugMode) {
            print(
                '‚úÖ Banner ad loaded successfully - Unit ID: $_bannerAdUnitId');
          }
        },
        onAdFailedToLoad: (ad, error) {
          if (kDebugMode) {
            print('‚ùå Banner ad failed to load - Unit ID: $_bannerAdUnitId');
            print('   Error code: ${error.code}');
            print('   Error message: ${error.message}');
            print('   Error domain: ${error.domain}');
          }
          ad.dispose();
        },
        onAdOpened: (ad) {
          if (kDebugMode) {
            print('Banner ad opened');
          }
        },
        onAdClosed: (ad) {
          if (kDebugMode) {
            print('Banner ad closed');
          }
        },
      ),
    );
  }

  // Charger une publicit√© interstitielle
  Future<InterstitialAd?> loadInterstitialAd() async {
    if (!adsEnabled) return null;

    try {
      InterstitialAd? interstitialAd;
      await InterstitialAd.load(
        adUnitId: _interstitialAdUnitId,
        request: const AdRequest(),
        adLoadCallback: InterstitialAdLoadCallback(
          onAdLoaded: (ad) {
            interstitialAd = ad;
            if (kDebugMode) {
              print(
                  '‚úÖ Interstitial ad loaded successfully - Unit ID: $_interstitialAdUnitId');
            }
          },
          onAdFailedToLoad: (error) {
            if (kDebugMode) {
              print(
                  '‚ùå Interstitial ad failed to load - Unit ID: $_interstitialAdUnitId');
              print('   Error code: ${error.code}');
              print('   Error message: ${error.message}');
              print('   Error domain: ${error.domain}');
            }
          },
        ),
      );
      return interstitialAd;
    } catch (e) {
      if (kDebugMode) {
        print('Error loading interstitial ad: $e');
      }
      return null;
    }
  }

  // Afficher une publicit√© interstitielle
  Future<bool> showInterstitialAd() async {
    if (!adsEnabled) return false;

    // V√©rifier si on doit afficher une pub (tous les 3 niveaux)
    if (_interstitialCounter < 3) {
      _interstitialCounter++;
      await _saveUserPreferences();
      return false;
    }

    final ad = await loadInterstitialAd();
    if (ad == null) return false;

    bool adShown = false;
    ad.fullScreenContentCallback = FullScreenContentCallback(
      onAdShowedFullScreenContent: (ad) {
        adShown = true;
        if (kDebugMode) {
          print('Interstitial ad showed full screen content');
        }
      },
      onAdDismissedFullScreenContent: (ad) {
        ad.dispose();
        _interstitialCounter = 0;
        _saveUserPreferences();
        if (kDebugMode) {
          print('Interstitial ad dismissed');
        }
      },
      onAdFailedToShowFullScreenContent: (ad, error) {
        ad.dispose();
        if (kDebugMode) {
          print('Interstitial ad failed to show: $error');
        }
      },
    );

    await ad.show();
    return adShown;
  }

  // Charger une publicit√© r√©compens√©e
  Future<RewardedAd?> loadRewardedAd() async {
    if (!adsEnabled) return null;

    try {
      RewardedAd? rewardedAd;
      await RewardedAd.load(
        adUnitId: _rewardedAdUnitId,
        request: const AdRequest(),
        rewardedAdLoadCallback: RewardedAdLoadCallback(
          onAdLoaded: (ad) {
            rewardedAd = ad;
            if (kDebugMode) {
              print(
                  '‚úÖ Rewarded ad loaded successfully - Unit ID: $_rewardedAdUnitId');
            }
          },
          onAdFailedToLoad: (error) {
            if (kDebugMode) {
              print(
                  '‚ùå Rewarded ad failed to load - Unit ID: $_rewardedAdUnitId');
              print('   Error code: ${error.code}');
              print('   Error message: ${error.message}');
              print('   Error domain: ${error.domain}');
            }
          },
        ),
      );
      return rewardedAd;
    } catch (e) {
      if (kDebugMode) {
        print('Error loading rewarded ad: $e');
      }
      return null;
    }
  }

  // Afficher une publicit√© r√©compens√©e
  Future<bool> showRewardedAd({
    required Function() onReward,
    required String rewardType,
  }) async {
    if (!adsEnabled) return false;

    final ad = await loadRewardedAd();
    if (ad == null) return false;

    bool rewardEarned = false;
    ad.fullScreenContentCallback = FullScreenContentCallback(
      onAdShowedFullScreenContent: (ad) {
        if (kDebugMode) {
          print('Rewarded ad showed full screen content');
        }
      },
      onAdDismissedFullScreenContent: (ad) {
        ad.dispose();
        if (kDebugMode) {
          print('Rewarded ad dismissed');
        }
      },
      onAdFailedToShowFullScreenContent: (ad, error) {
        ad.dispose();
        if (kDebugMode) {
          print('Rewarded ad failed to show: $error');
        }
      },
    );

    await ad.show(
      onUserEarnedReward: (ad, reward) {
        rewardEarned = true;
        onReward();
        if (kDebugMode) {
          print('User earned reward: ${reward.amount} ${reward.type}');
        }
      },
    );

    return rewardEarned;
  }

  // V√©rifier si on doit afficher une pub interstitielle
  bool shouldShowInterstitialAd(int currentLevel) {
    if (!adsEnabled) return false;

    // Afficher une pub selon la fr√©quence configur√©e
    if (currentLevel >
        _lastAdShownLevel + (AdMobConfig.interstitialFrequency - 1)) {
      _lastAdShownLevel = currentLevel;
      _saveUserPreferences();
      return true;
    }

    return false;
  }

  // Nouvelle m√©thode pour forcer l'affichage d'une pub interstitielle (pour les fins de niveau)
  bool shouldShowInterstitialAdOnLevelComplete(int currentLevel) {
    if (!adsEnabled) return false;

    // Afficher une pub √† la fin de chaque niveau gagn√© (plus agressif pour les revenus)
    // Mais seulement si on n'a pas d√©j√† affich√© une pub r√©cemment
    if (currentLevel > _lastAdShownLevel) {
      return true;
    }

    return false;
  }

  // Activer/d√©sactiver les publicit√©s
  Future<void> setAdsEnabled(bool enabled) async {
    _adsEnabled = enabled;
    await _saveUserPreferences();
    notifyListeners();
  }

  // Marquer l'achat "Sans publicit√©"
  Future<void> purchaseAdFree() async {
    _adFreePurchased = 1;
    await _saveUserPreferences();
    notifyListeners();
  }

  // R√©initialiser le compteur de pubs interstitielles
  Future<void> resetInterstitialCounter() async {
    _interstitialCounter = 0;
    await _saveUserPreferences();
  }

  // Obtenir les statistiques des publicit√©s
  Map<String, dynamic> getAdStats() {
    return {
      'adsEnabled': adsEnabled,
      'adFreePurchased': _adFreePurchased == 1,
      'interstitialCounter': _interstitialCounter,
      'lastAdShownLevel': _lastAdShownLevel,
    };
  }
}
